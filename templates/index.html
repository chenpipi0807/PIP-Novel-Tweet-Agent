{% extends "base.html" %}

{% block title %}åˆ›å»ºä»»åŠ¡ - çŸ­å‰§AIç”Ÿæˆç³»ç»Ÿ{% endblock %}

{% block extra_css %}
<style>
    h2 {
        font-size: 1.8em;
        margin-bottom: 30px;
        color: #e8eaed;
        font-weight: 600;
    }
    
    small {
        display: block;
        margin-top: 8px;
        font-size: 0.88em;
        color: #9ca3af;
    }
    
    .stats {
        display: inline-flex;
        gap: 20px;
        margin-top: 8px;
    }
    
    .stat-item {
        color: #6366f1;
        font-weight: 500;
    }
</style>
{% endblock %}

{% block content %}
<div id="app">
    <h2>åˆ›å»ºæ–°ä»»åŠ¡</h2>
    
    <div id="alert" style="display: none;"></div>
    
    <form id="taskForm">
        <div class="form-group">
            <label for="project_name">é¡¹ç›®åç§° *</label>
            <input type="text" id="project_name" name="project_name" required 
                   placeholder="è‡ªåŠ¨ç”Ÿæˆæˆ–æ‰‹åŠ¨è¾“å…¥">
            <small>åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ï¼ˆä¼šè‡ªåŠ¨ä»å°è¯´æ ‡é¢˜ç”Ÿæˆï¼‰</small>
        </div>
        
        <div class="form-group">
            <label for="timbre">é€‰æ‹©éŸ³è‰²</label>
            <select id="timbre" name="timbre">
                <option value="">åŠ è½½ä¸­...</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="novel_text">å°è¯´æ–‡æœ¬ *</label>
            <textarea id="novel_text" name="novel_text" required 
                      placeholder="è¾“å…¥å°è¯´å†…å®¹...&#10;&#10;å»ºè®®200å­—ä»¥å†…ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åˆ†å¥ç”Ÿæˆåˆ†é•œã€‚"></textarea>
            <small>
                <span class="stats">
                    <span>å­—æ•°: <span id="charCount" class="stat-item">0</span></span>
                    <span>é¢„è®¡åˆ†é•œ: <span id="sceneCount" class="stat-item">0</span>ä¸ª</span>
                    <span>é¢„è®¡æ—¶é•¿: <span id="estimatedTime" class="stat-item">0</span>åˆ†é’Ÿ</span>
                </span>
            </small>
        </div>
        
        <button type="submit" class="btn" id="submitBtn">
            ğŸš€ åˆ›å»ºä»»åŠ¡
        </button>
    </form>
</div>

<script>
// åŠ è½½éŸ³è‰²åˆ—è¡¨
fetch('/api/timbres')
    .then(res => res.json())
    .then(timbres => {
        const select = document.getElementById('timbre');
        select.innerHTML = '<option value="">é»˜è®¤éŸ³è‰²</option>';
        timbres.forEach(timbre => {
            const option = document.createElement('option');
            option.value = timbre;
            option.textContent = timbre;
            select.appendChild(option);
        });
    });

// æ¸…ç†é¡¹ç›®åç§°ï¼ˆç§»é™¤æ ‡ç‚¹ç¬¦å·ï¼‰
function cleanProjectName(text) {
    if (!text) return '';
    
    // ç§»é™¤æ‰€æœ‰æ ‡ç‚¹ç¬¦å·å’Œç©ºæ ¼
    let cleaned = text.replace(/[ï¼Œã€‚ï¼ï¼Ÿã€ï¼›ï¼š""''ï¼ˆï¼‰ã€Šã€‹ã€ã€‘\s,\.!?\-:;'"()\[\]{}<>]/g, '');
    
    // å¦‚æœæ¸…ç†åä¸ºç©ºæˆ–å¤ªçŸ­ï¼Œä½¿ç”¨æ—¶é—´æˆ³
    if (cleaned.length < 2) {
        const timestamp = Date.now().toString().slice(-6);
        cleaned = `novel_${timestamp}`;
    }
    
    return cleaned;
}

// è‡ªåŠ¨ç”Ÿæˆé¡¹ç›®åç§°
function generateProjectName(text) {
    if (!text || text.length < 5) return '';
    
    // å–å‰10ä¸ªå­—ç¬¦ä½œä¸ºé¡¹ç›®å
    let name = text.substring(0, 10);
    
    // æ¸…ç†æ ‡ç‚¹ç¬¦å·
    name = cleanProjectName(name);
    
    return name;
}

// å®æ—¶ç»Ÿè®¡å’Œè‡ªåŠ¨ç”Ÿæˆé¡¹ç›®å
const novelText = document.getElementById('novel_text');
const projectName = document.getElementById('project_name');
const charCount = document.getElementById('charCount');
const sceneCount = document.getElementById('sceneCount');
const estimatedTime = document.getElementById('estimatedTime');

let autoGenerateName = true;

// å¦‚æœç”¨æˆ·æ‰‹åŠ¨ä¿®æ”¹äº†é¡¹ç›®åç§°ï¼Œåœæ­¢è‡ªåŠ¨ç”Ÿæˆ
projectName.addEventListener('input', () => {
    if (projectName.value.length > 0) {
        autoGenerateName = false;
    }
});

novelText.addEventListener('input', () => {
    const text = novelText.value;
    const chars = text.length;
    
    // ä¼°ç®—åˆ†é•œæ•°ï¼ˆæŒ‰å¥å­åˆ†ï¼‰
    const sentences = text.split(/[ã€‚ï¼ï¼Ÿ.!?]/).filter(s => s.trim().length > 0).length;
    
    // ä¼°ç®—æ—¶é•¿ï¼ˆæ¯å¥çº¦3-5ç§’ï¼‰
    const minutes = Math.ceil(sentences * 4 / 60);
    
    charCount.textContent = chars;
    sceneCount.textContent = sentences;
    estimatedTime.textContent = minutes;
    
    // è‡ªåŠ¨ç”Ÿæˆé¡¹ç›®åç§°
    if (autoGenerateName && text.length >= 5) {
        projectName.value = generateProjectName(text);
    }
});

// æäº¤è¡¨å•
document.getElementById('taskForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submitBtn');
    const alert = document.getElementById('alert');
    
    // è·å–è¡¨å•æ•°æ®
    let projectNameValue = document.getElementById('project_name').value;
    
    // è‡ªåŠ¨æ¸…ç†é¡¹ç›®åç§°ï¼ˆç§»é™¤æ ‡ç‚¹ç¬¦å·ï¼‰
    projectNameValue = cleanProjectName(projectNameValue);
    
    // å¦‚æœæ¸…ç†åä¸ºç©ºï¼Œè‡ªåŠ¨ç”Ÿæˆ
    if (!projectNameValue) {
        projectNameValue = generateProjectName(document.getElementById('novel_text').value);
    }
    
    const formData = {
        project_name: projectNameValue,
        novel_text: document.getElementById('novel_text').value,
        timbre: document.getElementById('timbre').value
    };
    
    // ç¦ç”¨æŒ‰é’®
    submitBtn.disabled = true;
    submitBtn.textContent = 'åˆ›å»ºä¸­...';
    
    try {
        const response = await fetch('/api/create_task', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            alert.className = 'alert alert-success';
            alert.textContent = 'âœ“ ' + result.message + 'ï¼Œæ­£åœ¨è·³è½¬åˆ°ä»»åŠ¡ç®¡ç†é¡µé¢...';
            alert.style.display = 'block';
            
            // æ¸…ç©ºè¡¨å•
            document.getElementById('taskForm').reset();
            novelText.dispatchEvent(new Event('input'));
            
            // è·³è½¬åˆ°ä»»åŠ¡é¡µé¢
            setTimeout(() => {
                window.location.href = '/tasks';
            }, 1500);
        } else {
            throw new Error(result.error || 'åˆ›å»ºå¤±è´¥');
        }
    } catch (error) {
        alert.className = 'alert alert-error';
        alert.textContent = 'âŒ ' + error.message;
        alert.style.display = 'block';
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'ğŸš€ åˆ›å»ºä»»åŠ¡';
    }
});
</script>
{% endblock %}
