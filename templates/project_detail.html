{% extends "base.html" %}

{% block title %}é¡¹ç›®è¯¦æƒ… - {{ project_name }}{% endblock %}

{% block content %}
<div id="app">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <div>
            <a href="/tasks" style="color: #6366f1; text-decoration: none; margin-bottom: 10px; display: inline-block;">â† è¿”å›ä»»åŠ¡åˆ—è¡¨</a>
            <h2 style="margin: 0;">ğŸ“ {{ project_name }}</h2>
        </div>
        <div style="display: flex; gap: 12px;">
            <button class="btn" onclick="regenerateImages()" id="regenImagesBtn">
                ğŸ¨ é‡æ–°ç”Ÿæˆå›¾åƒ
            </button>
            <button class="btn" onclick="regenerateVideo()" id="regenVideoBtn">
                ğŸ¬ é‡æ–°åˆæˆè§†é¢‘
            </button>
        </div>
    </div>
    
    <div id="alert" style="display: none;"></div>
    
    <!-- è§†é¢‘é¢„è§ˆ -->
    <div id="videoSection" style="margin-bottom: 40px;">
        <h3 style="margin-bottom: 20px; color: #e8eaed;">è§†é¢‘é¢„è§ˆ</h3>
        <div class="video-container">
            <video controls id="videoPlayer">
                <source src="/api/video/{{ project_name }}" type="video/mp4">
            </video>
        </div>
    </div>
    
    <!-- åˆ†é•œåˆ—è¡¨ -->
    <div id="scenesSection">
        <h3 style="margin-bottom: 20px; color: #e8eaed;">åˆ†é•œåˆ—è¡¨</h3>
        <div id="scenesList"></div>
    </div>
</div>

<style>
    h2 {
        font-size: 1.8em;
        color: #e8eaed;
        font-weight: 600;
    }
    
    h3 {
        font-size: 1.3em;
        font-weight: 600;
    }
    
    .video-container {
        background: #242938;
        border-radius: 12px;
        padding: 20px;
        max-width: 800px;
    }
    
    .video-container video {
        width: 100%;
        border-radius: 8px;
    }
    
    .scene-card {
        background: #242938;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 24px;
        display: grid;
        grid-template-columns: 300px 1fr;
        gap: 24px;
        transition: all 0.3s;
    }
    
    .scene-card:hover {
        background: #2a3042;
    }
    
    .scene-image {
        width: 100%;
        border-radius: 8px;
        cursor: pointer;
        transition: transform 0.3s;
    }
    
    .scene-image:hover {
        transform: scale(1.05);
    }
    
    .scene-content {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }
    
    .scene-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .scene-index {
        font-size: 1.2em;
        font-weight: 600;
        color: #6366f1;
    }
    
    .scene-actions {
        display: flex;
        gap: 8px;
    }
    
    .btn-small {
        padding: 8px 16px;
        font-size: 0.85em;
        background: rgba(99, 102, 241, 0.2);
        color: #6366f1;
        border: 1px solid #6366f1;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .btn-small:hover {
        background: #6366f1;
        color: white;
    }
    
    .prompt-display {
        background: #1a1f2e;
        border: 2px solid #2d3548;
        border-radius: 8px;
        padding: 14px;
        color: #9ca3af;
        font-family: monospace;
        font-size: 0.9em;
        line-height: 1.6;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .prompt-display:hover {
        border-color: #6366f1;
    }
    
    .prompt-edit {
        width: 100%;
        min-height: 100px;
        background: #1a1f2e;
        border: 2px solid #6366f1;
        border-radius: 8px;
        padding: 14px;
        color: #e8eaed;
        font-family: monospace;
        font-size: 0.9em;
        line-height: 1.6;
        resize: vertical;
    }
    
    .prompt-edit:focus {
        outline: none;
        border-color: #8b5cf6;
    }
    
    .edit-actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
    }
    
    .image-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.9);
        z-index: 1000;
        cursor: pointer;
        padding: 40px;
    }
    
    .image-modal img {
        max-width: 100%;
        max-height: 100%;
        margin: auto;
        display: block;
    }
    
    .status-badge {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.8em;
        font-weight: 600;
    }
    
    .status-generating {
        background: rgba(251, 191, 36, 0.2);
        color: #fbbf24;
    }
</style>

<script>
const projectName = '{{ project_name }}';
let promptsData = null;
let editingSceneIndex = null;

// åŠ è½½åˆ†é•œæ•°æ®
async function loadScenes() {
    try {
        const response = await fetch(`/api/prompts/${projectName}`);
        promptsData = await response.json();
        
        const scenesList = document.getElementById('scenesList');
        
        if (!promptsData.scene_prompts || promptsData.scene_prompts.length === 0) {
            scenesList.innerHTML = '<div class="alert alert-info">æš‚æ— åˆ†é•œæ•°æ®</div>';
            return;
        }
        
        scenesList.innerHTML = promptsData.scene_prompts.map((scene, idx) => {
            const imgPath = `/api/image/${projectName}/${scene.index}`;
            
            return `
                <div class="scene-card" id="scene-${idx}">
                    <div>
                        <img src="${imgPath}" class="scene-image" onclick="showImageModal('${imgPath}')" 
                             onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22300%22 height=%22300%22><rect width=%22300%22 height=%22300%22 fill=%22%232d3548%22/><text x=%2250%25%22 y=%2250%25%22 fill=%22%239ca3af%22 text-anchor=%22middle%22 dy=%22.3em%22>å›¾ç‰‡åŠ è½½å¤±è´¥</text></svg>'">
                    </div>
                    <div class="scene-content">
                        <div class="scene-header">
                            <div class="scene-index">åˆ†é•œ ${scene.index}</div>
                            <div class="scene-actions">
                                <button class="btn-small" onclick="editPrompt(${idx})">
                                    âœï¸ ç¼–è¾‘
                                </button>
                                <button class="btn-small" onclick="regenerateScene(${idx})">
                                    ğŸ”„ é‡æ–°ç”Ÿæˆ
                                </button>
                            </div>
                        </div>
                        
                        <div id="prompt-display-${idx}" class="prompt-display" onclick="editPrompt(${idx})">
                            ${scene.prompt}
                        </div>
                        
                        <div id="prompt-edit-${idx}" style="display: none;">
                            <textarea class="prompt-edit" id="prompt-textarea-${idx}">${scene.prompt}</textarea>
                            <div class="edit-actions">
                                <button class="btn-small" onclick="cancelEdit(${idx})">å–æ¶ˆ</button>
                                <button class="btn-small" onclick="savePrompt(${idx})">ä¿å­˜</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
    } catch (error) {
        console.error('åŠ è½½å¤±è´¥:', error);
        document.getElementById('scenesList').innerHTML = 
            `<div class="alert alert-error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
    }
}

// æ˜¾ç¤ºå›¾ç‰‡æ¨¡æ€æ¡†
function showImageModal(imgPath) {
    const modal = document.createElement('div');
    modal.className = 'image-modal';
    modal.innerHTML = `<img src="${imgPath}">`;
    modal.onclick = () => modal.remove();
    document.body.appendChild(modal);
    modal.style.display = 'flex';
}

// ç¼–è¾‘æç¤ºè¯
function editPrompt(idx) {
    document.getElementById(`prompt-display-${idx}`).style.display = 'none';
    document.getElementById(`prompt-edit-${idx}`).style.display = 'block';
    editingSceneIndex = idx;
}

// å–æ¶ˆç¼–è¾‘
function cancelEdit(idx) {
    document.getElementById(`prompt-display-${idx}`).style.display = 'block';
    document.getElementById(`prompt-edit-${idx}`).style.display = 'none';
    editingSceneIndex = null;
}

// ä¿å­˜æç¤ºè¯
async function savePrompt(idx) {
    const textarea = document.getElementById(`prompt-textarea-${idx}`);
    const newPrompt = textarea.value;
    
    // æ›´æ–°æ•°æ®
    promptsData.scene_prompts[idx].prompt = newPrompt;
    
    try {
        const response = await fetch(`/api/prompts/${projectName}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(promptsData)
        });
        
        if (response.ok) {
            document.getElementById(`prompt-display-${idx}`).textContent = newPrompt;
            cancelEdit(idx);
            showAlert('success', 'âœ“ æç¤ºè¯å·²ä¿å­˜');
        } else {
            throw new Error('ä¿å­˜å¤±è´¥');
        }
    } catch (error) {
        showAlert('error', 'âŒ ' + error.message);
    }
}

// é‡æ–°ç”Ÿæˆå•ä¸ªåˆ†é•œ
async function regenerateScene(idx) {
    if (!confirm('ç¡®å®šè¦é‡æ–°ç”Ÿæˆè¿™ä¸ªåˆ†é•œå—ï¼Ÿ')) return;
    
    const sceneIndex = promptsData.scene_prompts[idx].index;
    
    try {
        const response = await fetch(`/api/regenerate_scene/${projectName}/${sceneIndex}`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showAlert('success', 'âœ“ å¼€å§‹é‡æ–°ç”Ÿæˆï¼Œè¯·ç¨å€™...');
            // 3ç§’ååˆ·æ–°å›¾ç‰‡
            setTimeout(() => {
                location.reload();
            }, 3000);
        } else {
            throw new Error(result.error || 'ç”Ÿæˆå¤±è´¥');
        }
    } catch (error) {
        showAlert('error', 'âŒ ' + error.message);
    }
}

// é‡æ–°ç”Ÿæˆæ‰€æœ‰å›¾åƒ
async function regenerateImages() {
    if (!confirm('ç¡®å®šè¦é‡æ–°ç”Ÿæˆæ‰€æœ‰å›¾åƒå—ï¼Ÿè¿™å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ã€‚')) return;
    
    const btn = document.getElementById('regenImagesBtn');
    btn.disabled = true;
    btn.textContent = 'ç”Ÿæˆä¸­...';
    
    try {
        const response = await fetch(`/api/regenerate_images/${projectName}`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showAlert('success', 'âœ“ å¼€å§‹é‡æ–°ç”Ÿæˆæ‰€æœ‰å›¾åƒï¼Œè¯·ç¨å€™...');
            setTimeout(() => {
                location.reload();
            }, 5000);
        } else {
            throw new Error(result.error || 'ç”Ÿæˆå¤±è´¥');
        }
    } catch (error) {
        showAlert('error', 'âŒ ' + error.message);
        btn.disabled = false;
        btn.textContent = 'ğŸ¨ é‡æ–°ç”Ÿæˆå›¾åƒ';
    }
}

// é‡æ–°åˆæˆè§†é¢‘
async function regenerateVideo() {
    if (!confirm('ç¡®å®šè¦é‡æ–°åˆæˆè§†é¢‘å—ï¼Ÿ')) return;
    
    const btn = document.getElementById('regenVideoBtn');
    btn.disabled = true;
    btn.textContent = 'åˆæˆä¸­...';
    
    try {
        const response = await fetch(`/api/regenerate_video/${projectName}`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showAlert('success', 'âœ“ å¼€å§‹é‡æ–°åˆæˆè§†é¢‘ï¼Œè¯·ç¨å€™...');
            setTimeout(() => {
                location.reload();
            }, 3000);
        } else {
            throw new Error(result.error || 'åˆæˆå¤±è´¥');
        }
    } catch (error) {
        showAlert('error', 'âŒ ' + error.message);
        btn.disabled = false;
        btn.textContent = 'ğŸ¬ é‡æ–°åˆæˆè§†é¢‘';
    }
}

// æ˜¾ç¤ºæç¤º
function showAlert(type, message) {
    const alert = document.getElementById('alert');
    alert.className = `alert alert-${type}`;
    alert.textContent = message;
    alert.style.display = 'block';
    
    setTimeout(() => {
        alert.style.display = 'none';
    }, 3000);
}

// åŠ è½½æ•°æ®
loadScenes();
</script>
{% endblock %}
